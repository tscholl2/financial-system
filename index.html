<!DOCTYPE html>
<html>

<head>
    <title>Finances</title>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="https://unpkg.com/98.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #c0c0c0;
            font-family: monospace;
        }

        #app {
            display: grid;
            gap: 20px;
            grid-template-columns: 1fr 3fr;
            grid-template-areas:
                "header  header"
                "sidebar content"
                "sidebar content"
                "footer  footer";
        }

        nav {
            grid-area: header;
        }

        main {
            grid-area: content;
        }

        main>ul {
            display: flex;
            justify-content: space-around;
            flex-direction: row;
            flex-wrap: wrap;
        }

        main>ul>li {
            list-style: none;
            margin: 10px;
        }

        .card {
            width: 320px;
            height: 240px;
        }

        aside {
            grid-area: sidebar;
            padding-left: 20px;
            min-width: 250px;
        }

        aside>ul {
            min-height: 90vh;
        }

        footer {
            grid-area: footer;
        }
    </style>
    <script>
        var Controller = function () { return function (t) { var n = this; this.p = [], this.l = [], this.getState = function () { return n.s }, this.addPlugin = function (t) { n.p.push(t) }, this.removePlugin = function (t) { n.p = n.p.filter(function (n) { return n !== t }) }, this.addListener = function (t) { n.l.push(t) }, this.removeListener = function (t) { n.l = n.l.filter(function (n) { return n !== t }) }, this.dispatch = function (t) { n.p.forEach(function (n) { return t = n(t) }); var i = t(n.s); n.s !== i && (n.s = i, n.l.forEach(function (t) { return t(n.s, n.dispatch) })) }, this.s = t } }();
    </script>
    <script src="https://unpkg.com/papaparse@5.3.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { h, text, patch } from "https://unpkg.com/superfine@8.2.0/index.js"
        /*
        async function loadAverages() {
            const data = await loadData();
            console.log(data);

            const start_date = new Date(Math.min.apply(null, data.items.map(i => i.date)));
            const end_date = new Date();
            const delta = end_date.getTime() - start_date.getTime();
            let h1;
            h1 = document.createElement("h1");
            h1.textContent = displayTimeSince(start_date, end_date);
            document.body.appendChild(h1);
            h1 = document.createElement("h1");
            h1.textContent = `$/day: ${(total / (delta / (24 * 60 * 60 * 1000))).toFixed(2)}`;
            document.body.appendChild(h1);
            h1 = document.createElement("h1");
            h1.textContent = `$/month: ${(total / (delta / (30 * 24 * 60 * 60 * 1000))).toFixed(2)}`;
            document.body.appendChild(h1);
            for (let c of data.categories) {
                h1 = document.createElement("h1");
                h1.textContent = `$/month in ${c}: ${(total_by_category[c] / (delta / (30 * 24 * 60 * 60 * 1000))).toFixed(2)}`;
                document.body.appendChild(h1);
            }
            for (let c of data.locations) {
                h1 = document.createElement("h1");
                h1.textContent = `$/month at ${c}: ${(total_by_location[c] / (delta / (30 * 24 * 60 * 60 * 1000))).toFixed(2)}`;
                document.body.appendChild(h1);
            }
        }
        */
        window._data = undefined;
        window._csv = undefined;

        async function loadCSV() {
            if (window._csv) {
                return window._csv
            }
            const resp = await fetch("sample.csv");
            if (resp.status != 200) {
                throw new Error(`Unable to download data: ${resp.status}:${resp.statusText}`);
            }
            window._csv = await resp.text();
            return window._csv;
        }

        async function loadData() {
            const data = Papa.parse(await loadCSV());
            if (data.errors.length > 0) {
                throw new Error(`Unable to parse data: ${data.errors}`);
            }
            const headers = data.data[0];
            const items = [];
            for (let values of data.data.slice(1)) {
                const item = {};
                for (let i = 0; i < values.length; i++) {
                    switch (headers[i]) {
                        case "date":
                            item[headers[i]] = new Date(values[i]);
                            break;
                        case "cost":
                            item[headers[i]] = parseFloat(values[i].replace(/[\$\,]/g, ""));
                            if (isNaN(item.cost)) {
                                throw new Error(`Unable to parse cost: ${values}`);
                            }
                            break;
                        default:
                            item[headers[i]] = values[i];
                            break;
                    }
                }
                items.push(item);
            }
            const categories = Array.from(new Set(items.map(i => i["category"])));
            const locations = Array.from(new Set(items.map(i => i["location"])));
            const total_by_category = {};
            for (let c of categories) {
                total_by_category[c] = 0;
            }
            const total_by_location = {};
            for (let c of locations) {
                total_by_location[c] = 0;
            }
            let total = 0;
            for (let i of items) {
                const a = i.category == "income" ? Math.abs(i.cost) : -Math.abs(i.cost);
                total_by_category[i.category] += a;
                total_by_location[i.location] += a;
                total += a;
            }
            const start = new Date(Math.min.apply(null, items.map(i => i.date)));
            const end = new Date();
            const delta = end.getTime() - start.getTime();
            window._data = {
                items,
                categories,
                locations,
                total_by_category,
                total_by_location,
                total,
                start,
                end,
                delta,
            };
            return window._data;
        }

        function daysInMonth(month, year) {
            return new Date(year, month, 0).getDate();
        }

        function displayTimeSince(A, B) {
            const Ay = A.getFullYear();
            const By = B.getFullYear();
            const Am = A.getMonth();
            const Bm = B.getMonth();
            const As = A.getTime();
            const Bs = B.getTime();
            let M = 12 * (By - Ay) + (Bm - Am);
            const Y = Math.floor(M / 12);
            M = M % 12;
            return `Elapsed: ${Y} years, ${M} months, ${B.getDate() - A.getDate()} days`
        }

        function Navbar() {
            return function () {
                return h("head", {}, [
                    h("div", { class: "title-bar-text" }, text("Fin$")),
                ]);
            }
        }

        function Card(title, children) {
            return h("div", { class: "window card" }, [
                h("div", { class: "title-bar" }, [
                    h("div", { class: "title-bar-text" }, text(title))
                ]),
                h("div", { class: "window-body" },
                    children,
                    // text("??? $ / ???"),
                    // h("img", { height: "100px", width: "100px", alt: "???", src: "//via.placeholder.com/100x100" }),
                ),
            ]);
        }

        function cumulativeSum(items) {
            const data = {
                type: 'line',
                data: {
                    datasets: [{
                        data: []
                    }]
                }
            };
            let total = 0;
            for (let item of items) {
                total += Math.abs(item.cost) * (item.category == "income" ? 1 : -1);
                data.data.datasets[0].data.push({ x: item.date.getTime(), y: total })
            }
            return data;
        }

        function Content(dispatch) {
            return function (state) {
                const { page, total, delta, items = [] } = state;
                if (page == "averages") {
                    const perDay = total / (delta / (1000 * 60 * 60 * 24));
                    const perMonth = total / (delta / (1000 * 60 * 60 * 24 * 30));
                    const config = cumulativeSum(state.items);
                    const myChart = new Chart(document.getElementById('avg-day-graph'), config);
                    console.log(myChart);
                    return h("main", {}, [
                        h("ul", {}, [
                            h("li", {}, Card("Totals", [
                                h("span", { style: `color: ${perDay > 0 ? "green" : "red"}` }, text(`${perDay > 0 ? "+" : "-"}${perDay.toFixed(2)} / Day`)),
                                h("canvas", { id: "avg-day-graph" }),
                            ])),
                            h("li", {}, Card("Totals", [
                                h("span", { style: `color: ${perMonth > 0 ? "green" : "red"}` }, text(`${perMonth > 0 ? "+" : "-"}${perMonth.toFixed(2)} / Month`)),
                            ])),
                        ])
                    ]);
                }
                return h("main", {}, [
                    h("ul", {}, [
                        h("li", {}, Card("title", [text("child")])),
                    ])
                ]);
            }
        }

        function Footer() {
            return function () {
                return h("footer", {}, [
                    text("Footer"),
                ]);
            }
        }

        function Sidebar(dispatch) {
            return function (state) {
                return h("aside", { class: "sidebar" }, [
                    h("ul", { class: "tree-view" }, [
                        h("li", {},
                            h("form", { class: "field-row" }, [
                                h("label", { for: "search-input" }, text("Search")),
                                h("input", { id: "search-input", type: "text" }),
                            ])
                        ),
                        h("li", {}, text("Sections")),
                        h("li", {}, [
                            h("details", { open: state.page == "averages" }, [
                                h("summary", {}, text("Averages")),
                            ]),
                            h("details", { open: state.page == "categories" }, [
                                h("summary", {}, text("Categories")),
                                h("ul", {},
                                    state.categories.map(c => h("li", { key: c }, text(c))),
                                ),
                            ]),
                            h("details", { open: state.page == "locations" }, [
                                h("summary", {}, text("Locations")),
                                h("ul", {},
                                    state.locations.map(c => h("li", { key: c }, text(c))),
                                ),
                            ]),
                        ]),
                    ]),
                ]);
            }
        }

        function App(dispatch) {
            /*
            const inc = () => dispatch(s => ({ ...s, value: s.value - 1 }));
            const dec = () => dispatch(s => ({ ...s, value: s.value + 1 }));
            h("h1", {}, text(state.value)),
            h("button", { onclick: inc }, text("-")),
            h("button", { onclick: dec }, text("+")),
            */
            const sidebar = Sidebar(dispatch);
            const content = Content(dispatch);
            const navbar = Navbar(dispatch);
            const footer = Footer(dispatch);
            return function (state) {
                if (state.intializing) {
                    return h("div", {}, [h("progress", {})]);
                }
                return h("div", {}, [
                    navbar(state),
                    sidebar(state),
                    content(state),
                    footer(state),
                ])
            }
        }

        async function start() {
            const c = new Controller({
                intializing: true,
                page: "averages",
            });
            const app = App(c.dispatch);
            c.addListener(s => patch(document.getElementById("app"), app(s)));
            const data = await loadData();
            c.dispatch(s => ({ ...s, intializing: false, ...data }));
        }
        start();
    </script>
</head>

<body>
    <div id="app">
        <!--TODO-->
    </div>
    <!--
        <head>
            <nav class="title-bar">
                <div class="title-bar-text">Fin$</div>
            </nav>
        </head>
        <aside>
            <ul class="tree-view">
                <li>Sections</li>
                <li>
                    <details>
                        <summary>Categories</summary>
                        <ul>
                            <li>???</li>
                        </ul>
                    </details>
                </li>
                <li>
                    <details>
                        <summary>Locations</summary>
                        <ul>
                            <li>???</li>
                        </ul>
                    </details>
                </li>
            </ul>
        </aside>
        <main>
            <ul id="cards">
                <li>
                    <div class="window" style="width: 320px">
                        <div class="title-bar">
                            <div class="title-bar-text">Name of Category</div>
                        </div>
                        <div class="window-body">
                            ??? $ / ???
                            <img height="100px" width="100px" alt="graph" src="//via.placeholder.com/100x100" />
                        </div>
                    </div>
                </li>
                <li>
                    <div class="window" style="width: 320px">
                        <div class="title-bar">
                            <div class="title-bar-text">Name of Category</div>
                        </div>
                        <div class="window-body">
                            ??? $ / ???
                            <img height="100px" width="100px" alt="graph" src="//via.placeholder.com/100x100" />
                        </div>
                    </div>
                </li>
                <li>
                    <div class="window" style="width: 320px">
                        <div class="title-bar">
                            <div class="title-bar-text">Name of Category</div>
                        </div>
                        <div class="window-body">
                            ??? $ / ???
                            <img height="100px" width="100px" alt="graph" src="//via.placeholder.com/100x100" />
                        </div>
                    </div>
                </li>
            </ul>
        </main>
        <footer>Footer</footer>
    -->

</body>

</html>