<!DOCTYPE html>
<html>

<head>
    <title>Finances</title>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="https://unpkg.com/98.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #c0c0c0;
            font-family: monospace;
        }

        #app {
            display: grid;
            gap: 20px;
            grid-template-columns: 1fr 3fr;
            grid-template-areas:
                "header  header"
                "sidebar content"
                "sidebar content"
                "footer  footer";
        }

        nav {
            grid-area: header;
        }

        main {
            grid-area: content;
        }

        main>ul {
            display: flex;
            justify-content: space-around;
            flex-direction: row;
            flex-wrap: wrap;
        }

        main>ul>li {
            list-style: none;
            margin: 10px;
        }

        .card {
            width: 320px;
            height: 240px;
        }

        aside {
            grid-area: sidebar;
            padding-left: 20px;
            min-width: 250px;
        }

        aside>ul {
            min-height: 90vh;
        }

        footer {
            grid-area: footer;
        }
    </style>
    <script>
        var Controller = function () { return function (t) { var n = this; this.p = [], this.l = [], this.getState = function () { return n.s }, this.addPlugin = function (t) { n.p.push(t) }, this.removePlugin = function (t) { n.p = n.p.filter(function (n) { return n !== t }) }, this.addListener = function (t) { n.l.push(t) }, this.removeListener = function (t) { n.l = n.l.filter(function (n) { return n !== t }) }, this.dispatch = function (t) { n.p.forEach(function (n) { return t = n(t) }); var i = t(n.s); n.s !== i && (n.s = i, n.l.forEach(function (t) { return t(n.s, n.dispatch) })) }, this.s = t } }();
    </script>
    <script src="https://unpkg.com/papaparse@5.3.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { h, text, patch } from "https://unpkg.com/superfine@8.2.0/index.js";
        import Fuse from "https://cdn.jsdelivr.net/npm/fuse.js@6.5.3/dist/fuse.esm.js";

        window._data = undefined;

        async function loadData() {
            const resp = await fetch("sample.csv");
            if (resp.status != 200) {
                throw new Error(`Unable to download data: ${resp.status}:${resp.statusText}`);
            }
            const csv = window._csv = await resp.text();
            // parse
            const data = Papa.parse(csv);
            if (data.errors.length > 0) {
                throw new Error(`Unable to parse data: ${data.errors}`);
            }
            const headers = data.data[0];
            const items = [];
            for (let values of data.data.slice(1)) {
                const item = {};
                for (let i = 0; i < values.length; i++) {
                    switch (headers[i]) {
                        case "date":
                            item[headers[i]] = new Date(values[i]);
                            break;
                        case "cost":
                            item[headers[i]] = parseFloat(values[i].replace(/[\$\,]/g, ""));
                            if (isNaN(item.cost)) {
                                throw new Error(`Unable to parse cost: ${values}`);
                            }
                            break;
                        default:
                            item[headers[i]] = values[i];
                            break;
                    }
                }
                items.push(item);
            }
            return window._data = { items };
        }

        const selectCategories = memoize((items) =>
            Array.from(new Set(items.map(i => i["category"].toLowerCase()))));

        const selectLocations = memoize((items) =>
            Array.from(new Set(items.map(i => i["location"].toLowerCase()))));

        const selectDescriptions = memoize((items) =>
            Array.from(new Set(items.map(i => i["item"].toLowerCase()))));

        const selectTotalsByCategory = memoize((items) =>
            items.reduce((p, n) => {
                p[n.category] = (p[n.category] || 0) + getCost(n);
                return p;
            }, {}));

        const selectTotalsByLocation = memoize((items) =>
            items.reduce((p, n) => {
                p[n.category] = (p[n.category] || 0) + getCost(n);
                return p;
            }, {}));

        const selectTotalsByDescription = memoize((items) =>
            items.reduce((p, n) => {
                p[n.item] = (p[n.item] || 0) + getCost(n);
                return p;
            }, {}));

        const selectTotal = memoize((items) => items.reduce((p, n) => p + getCost(n), 0));

        const selectStartDate = memoize((items) => new Date(Math.min.apply(null, items.map(i => i.date))));


        function daysInMonth(month, year) {
            return new Date(year, month, 0).getDate();
        }

        function displayTimeSince(A, B) {
            const Ay = A.getFullYear();
            const By = B.getFullYear();
            const Am = A.getMonth();
            const Bm = B.getMonth();
            const As = A.getTime();
            const Bs = B.getTime();
            let M = 12 * (By - Ay) + (Bm - Am);
            const Y = Math.floor(M / 12);
            M = M % 12;
            return `Elapsed: ${Y} years, ${M} months, ${B.getDate() - A.getDate()} days`
        }

        function Navbar() {
            return function () {
                return h("head", {}, [
                    h("div", { class: "title-bar-text" }, text("Fin$")),
                ]);
            }
        }

        function Card(title, children) {
            return h("div", { class: "window card" }, [
                h("div", { class: "title-bar" }, [
                    h("div", { class: "title-bar-text" }, text(title))
                ]),
                h("div", { class: "window-body" }, children),
            ]);
        }


        function memoize(f) {
            const cache = {};
            return (...args) => {
                if (cache === {} || cache.args?.length !== args.length || args.some((a, i) => a !== cache.args[i])) {
                    cache.args = args;
                    cache.val = f(...args);
                }
                return cache.val;
            }
        }

        function getCost(item) {
            if (item.category === "income") {
                return Math.abs(item.cost);
            }
            return -Math.abs(item.cost);
        }

        const DailyChart = memoize((items) => {
            items = [...items].sort((a, b) => a.date - b.date);
            if (items.length === 0) {
                return h("span", {}, text("No items :("));
            }
            const labels = [];
            const data = items.reduce((p, n, i) => {
                const l = items[Math.max(i - 1, 0)];
                const sum = p[p.length - 1] + getCost(n);
                if (n.date.toDateString() === l.date.toDateString()) {
                    p[p.length - 1] = sum;
                } else {
                    p.push(sum);
                    labels.push(n.date.toDateString());
                }
                return p;
            }, [items[0].cost]).slice(1)
            const config = {
                type: "line",
                data: {
                    labels,
                    datasets: [{
                        label: "Daily Totals",
                        backgroundColor: 'rgb(255, 99, 132)',
                        borderColor: 'rgb(255, 99, 132)',
                        data,
                    }]
                }
            }
            return ChartComponent(config);
        });

        function ChartComponent(config) {
            const vnode = h("canvas", {});
            window.requestAnimationFrame(() => {
                console.log("updating chart!", vnode.node)
                if (vnode?.node == null) {
                    console.error(`expected node, got nothing: ${vnode}`);
                }
                const oldChart = vnode.node._chart;
                if (oldChart) {
                    oldChart.data = { ...oldChart.data, ...config };
                    oldChart.update;
                } else {
                    vnode.node._chart = new Chart(vnode.node, config);
                }
            });
            return vnode;
        }


        function MonthlyCosts(items) {
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const getMonthYear = (d) => `${d.getMonth()}/${d.getFullYear()}`;
            items = [...items].sort((a, b) => a.date - b.date);
            if (items.length === 0) {
                return h("span", {}, text("No items :("));
            }
            const labels = [];
            const data = items.reduce((p, n, i) => {
                const l = items[Math.max(i - 1, 0)];
                if (getMonthYear(n.date) === getMonthYear(l.date)) {
                    p[p.length - 1] += getCost(n);
                } else {
                    p.push(getCost(n));
                    labels.push(`${months[n.date.getMonth()]} ${n.date.getFullYear()}`);
                }
                return p;
            }, [items[0].cost]).slice(1)
            const config = {
                type: "line",
                data: {
                    labels,
                    datasets: [{
                        label: "Monthly Totals",
                        backgroundColor: 'rgb(255, 99, 132)',
                        borderColor: 'rgb(255, 99, 132)',
                        data,
                    }]
                }
            }
            return ChartComponent(config);
        }

        const MonthlyTotals = memoize((items) => {
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const getMonthYear = (d) => `${d.getMonth()}/${d.getFullYear()}`;
            items = [...items].sort((a, b) => a.date - b.date);
            if (items.length === 0) {
                return h("span", {}, text("No items :("));
            }
            const labels = [];
            const data = items.reduce((p, n, i) => {
                const l = items[Math.max(i - 1, 0)];
                const sum = p[p.length - 1] + getCost(n);
                if (getMonthYear(n.date) === getMonthYear(l.date)) {
                    p[p.length - 1] = sum;
                } else {
                    p.push(sum);
                    labels.push(`${months[n.date.getMonth()]} ${n.date.getFullYear()}`);
                }
                return p;
            }, [items[0].cost]).slice(1)
            const config = {
                type: "line",
                data: {
                    labels,
                    datasets: [{
                        label: "Monthly Totals",
                        backgroundColor: 'rgb(255, 99, 132)',
                        borderColor: 'rgb(255, 99, 132)',
                        data,
                    }]
                }
            }
            return ChartComponent(config);
        });

        function Content(dispatch) {
            // TODO fuse
            const selectItems = memoize((items = [], search = "") => items);
            return function (state) {
                const { page = "averages", search = "", items: allItems } = state;
                if (state.search === "blank")
                    return h("main", {});
                const items = selectItems(allItems, search);
                const delta = new Date() - selectStartDate(allItems);
                const total = selectTotal(allItems);
                const canvas = document.createElement("canvas");
                const perDay = total / (delta / (1000 * 60 * 60 * 24));
                const perMonth = total / (delta / (1000 * 60 * 60 * 24 * 30));
                return h("main", {}, [
                    h("ul", {}, [
                        h("li", {}, Card("Daily Totals", [
                            h("span", { style: `color: ${perDay > 0 ? "green" : "red"}` }, text(`${perDay > 0 ? "+" : "-"}${perDay.toFixed(2)} / Day`)),
                            DailyChart(items),
                        ])),
                        h("li", {}, Card("Monthly Totals", [
                            h("span", { style: `color: ${perMonth > 0 ? "green" : "red"}` }, text(`${perMonth > 0 ? "+" : "-"}${perMonth.toFixed(2)} / Month`)),
                            MonthlyTotals(items),
                        ])),
                        h("li", {}, Card("Monthly Costs", [
                            h("span", { style: `color: ${perMonth > 0 ? "green" : "red"}` }, text(`${perMonth > 0 ? "+" : "-"}${perMonth.toFixed(2)} / Month`)),
                            MonthlyCosts(items),
                        ])),
                    ])
                ]);
            }
        }

        function Footer() {
            return function () {
                return h("footer", {}, [
                    text("Footer"),
                ]);
            }
        }

        function Sidebar(dispatch) {
            const handleInput = (e) => {
                dispatch(s => ({ ...s, search: e.target.value }));
            }
            return function (state) {
                return h("aside", { class: "sidebar" }, [
                    h("ul", { class: "tree-view" }, [
                        h("li", {},
                            h("form", { class: "field-row" }, [
                                h("label", { for: "search-input" }, text("Search")),
                                h("input", { id: "search-input", type: "text", oninput: handleInput }),
                            ])
                        ),
                        h("li", {}, text("Sections")),
                        h("li", {}, [
                            h("details", {}, [
                                h("summary", {}, text("Averages")),
                            ]),
                            h("details", {}, [
                                h("summary", {}, text("Categories")),
                                h("ul", {},
                                    selectCategories(state.items).map(c => h("li", { key: c }, text(c))),
                                ),
                            ]),
                            h("details", {}, [
                                h("summary", {}, text("Locations")),
                                h("ul", {},
                                    selectLocations(state.items).map(c => h("li", { key: c }, text(c))),
                                ),
                            ]),
                            h("details", {}, [
                                h("summary", {}, text("Descriptions")),
                                h("ul", {},
                                    selectDescriptions(state.items).map(c => h("li", { key: c }, text(c))),
                                ),
                            ]),
                        ]),
                    ]),
                ]);
            }
        }

        function App(dispatch) {
            /*
            const inc = () => dispatch(s => ({ ...s, value: s.value - 1 }));
            const dec = () => dispatch(s => ({ ...s, value: s.value + 1 }));
            h("h1", {}, text(state.value)),
            h("button", { onclick: inc }, text("-")),
            h("button", { onclick: dec }, text("+")),
            */
            const sidebar = Sidebar(dispatch);
            const content = Content(dispatch);
            const navbar = Navbar(dispatch);
            const footer = Footer(dispatch);
            return function (state) {
                if (state.intializing) {
                    return h("div", {}, [h("progress", {})]);
                }
                return h("div", {}, [
                    navbar(state),
                    sidebar(state),
                    content(state),
                    footer(state),
                ])
            }
        }

        async function start() {
            const c = new Controller({ intializing: true });
            const app = App(c.dispatch);
            c.addListener(s => patch(document.getElementById("app"), app(s)));
            c.addListener(s => window._state = s);
            const data = await loadData();
            c.dispatch(s => ({ ...s, intializing: false, ...data }));
        }
        start();
    </script>
</head>

<body>
    <div id="app">
        <!--TODO-->
    </div>
    <!--
        <head>
            <nav class="title-bar">
                <div class="title-bar-text">Fin$</div>
            </nav>
        </head>
        <aside>
            <ul class="tree-view">
                <li>Sections</li>
                <li>
                    <details>
                        <summary>Categories</summary>
                        <ul>
                            <li>???</li>
                        </ul>
                    </details>
                </li>
                <li>
                    <details>
                        <summary>Locations</summary>
                        <ul>
                            <li>???</li>
                        </ul>
                    </details>
                </li>
            </ul>
        </aside>
        <main>
            <ul id="cards">
                <li>
                    <div class="window" style="width: 320px">
                        <div class="title-bar">
                            <div class="title-bar-text">Name of Category</div>
                        </div>
                        <div class="window-body">
                            ??? $ / ???
                            <img height="100px" width="100px" alt="graph" src="//via.placeholder.com/100x100" />
                        </div>
                    </div>
                </li>
                <li>
                    <div class="window" style="width: 320px">
                        <div class="title-bar">
                            <div class="title-bar-text">Name of Category</div>
                        </div>
                        <div class="window-body">
                            ??? $ / ???
                            <img height="100px" width="100px" alt="graph" src="//via.placeholder.com/100x100" />
                        </div>
                    </div>
                </li>
                <li>
                    <div class="window" style="width: 320px">
                        <div class="title-bar">
                            <div class="title-bar-text">Name of Category</div>
                        </div>
                        <div class="window-body">
                            ??? $ / ???
                            <img height="100px" width="100px" alt="graph" src="//via.placeholder.com/100x100" />
                        </div>
                    </div>
                </li>
            </ul>
        </main>
        <footer>Footer</footer>
    -->

</body>

</html>